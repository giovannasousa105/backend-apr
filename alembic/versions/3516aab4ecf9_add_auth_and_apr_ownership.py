"""add auth and apr ownership

Revision ID: 3516aab4ecf9
Revises: ef56gh78ij90
Create Date: 2026-01-23 18:47:28.834648

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '3516aab4ecf9'
down_revision: Union[str, Sequence[str], None] = 'ef56gh78ij90'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    tables = set(inspector.get_table_names())
    if 'companies' not in tables:
        op.create_table(
            'companies',
            sa.Column('id', sa.Integer(), nullable=False),
            sa.Column('name', sa.String(length=255), nullable=False),
            sa.Column('created_at', sa.DateTime(), nullable=False),
            sa.Column('updated_at', sa.DateTime(), nullable=False),
            sa.PrimaryKeyConstraint('id'),
            sa.UniqueConstraint('name'),
        )
    if 'users' not in tables:
        op.create_table(
            'users',
            sa.Column('id', sa.Integer(), nullable=False),
            sa.Column('email', sa.String(length=255), nullable=False),
            sa.Column('name', sa.String(length=255), nullable=True),
            sa.Column('password_hash', sa.String(length=255), nullable=False),
            sa.Column('role', sa.String(length=20), nullable=False),
            sa.Column('company_id', sa.Integer(), nullable=False),
            sa.Column('api_token', sa.String(length=64), nullable=False),
            sa.Column('is_active', sa.Boolean(), nullable=False),
            sa.Column('created_at', sa.DateTime(), nullable=False),
            sa.Column('updated_at', sa.DateTime(), nullable=False),
            sa.ForeignKeyConstraint(['company_id'], ['companies.id'], ondelete='CASCADE'),
            sa.PrimaryKeyConstraint('id'),
            sa.UniqueConstraint('api_token'),
            sa.UniqueConstraint('email'),
        )
        op.create_index('ix_users_company_id', 'users', ['company_id'], unique=False)
        op.create_index('ix_users_email', 'users', ['email'], unique=False)
        op.create_index('ix_users_api_token', 'users', ['api_token'], unique=False)
    apr_columns = {col["name"] for col in inspector.get_columns("aprs")}
    apr_fks = inspector.get_foreign_keys("aprs")
    apr_indexes = {idx["name"] for idx in inspector.get_indexes("aprs")}
    has_user_fk = any(fk.get("referred_table") == "users" for fk in apr_fks)
    has_company_fk = any(fk.get("referred_table") == "companies" for fk in apr_fks)

    with op.batch_alter_table("aprs") as batch_op:
        if "company_id" not in apr_columns:
            batch_op.add_column(sa.Column("company_id", sa.Integer(), nullable=True))
        if "user_id" not in apr_columns:
            batch_op.add_column(sa.Column("user_id", sa.Integer(), nullable=True))
        if not has_user_fk:
            batch_op.create_foreign_key(
                "fk_aprs_user_id",
                "users",
                ["user_id"],
                ["id"],
                ondelete="SET NULL",
            )
        if not has_company_fk:
            batch_op.create_foreign_key(
                "fk_aprs_company_id",
                "companies",
                ["company_id"],
                ["id"],
                ondelete="CASCADE",
            )

    if op.f("ix_aprs_company_id") not in apr_indexes:
        op.create_index(op.f("ix_aprs_company_id"), "aprs", ["company_id"], unique=False)
    if op.f("ix_aprs_user_id") not in apr_indexes:
        op.create_index(op.f("ix_aprs_user_id"), "aprs", ["user_id"], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("aprs") as batch_op:
        batch_op.drop_constraint("fk_aprs_user_id", type_="foreignkey")
        batch_op.drop_constraint("fk_aprs_company_id", type_="foreignkey")
        batch_op.drop_column("user_id")
        batch_op.drop_column("company_id")
    op.drop_index(op.f('ix_aprs_user_id'), table_name='aprs')
    op.drop_index(op.f('ix_aprs_company_id'), table_name='aprs')
    op.drop_index('ix_users_api_token', table_name='users')
    op.drop_index('ix_users_email', table_name='users')
    op.drop_index('ix_users_company_id', table_name='users')
    op.drop_table('users')
    op.drop_table('companies')
    # ### end Alembic commands ###
